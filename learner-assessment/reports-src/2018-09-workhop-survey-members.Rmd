---
## To build this report, run: `source("build_reports.Rmd")` in the 
## directory one level above

## KLJ >> I want the title of each report to include the member site that the report is written for
title: Carpentries Member Site Bi-Annual Report
authors:
- Kari L. Jordan^[https://twitter.com/drkariljordan]
- François Michonneau^[https://twitter.com/fmic_]
date: September 30, 2018
params:
  org: ""
output:
  html_document:
    self_contained: no
    toc: true
    toc_float: true
    lib_dir: "../reports-members/2018-09/libs"
  pdf_document:
    toc: true
    highlight: zenburn
    df_print: kable
---

```{r setup, include=FALSE}
library(tidyverse)
library(knitr)
library(likert)
library(srvyr)
library(NPS)
library(broom)
library(assertr)
library(viridis)
library(patchwork)
library(scales)
library(ggalt)

opts_chunk$set(echo = FALSE,
               message = FALSE,
               warning = FALSE)

if (opts_knit$get("rmarkdown.pandoc.to") == "latex") {
    figout <- "\\maxwidth"
} else {
    figout <- NULL   
}

## puts all figures in figures folder
opts_chunk$set(fig.path = paste0('../../figures/', abbreviate(params$org)),
               fig.width = 10, fig.retina = 2, out.width = figout)


to_snake_case <- function(x) {
    x <- gsub("([A-Z])([A-Z][a-z]+)", "\\1_\\2", x)
    tolower(gsub("([a-z])([A-Z])", "\\1_\\2", x))
}

## returns TRUE when the respondent has answered at least one question.
has_answers <- function(d) {
    d %>%
        select(-matches("date")) %>%
        mutate(has_answers = rowSums(is.na(.)) < ncol(.)) %>%
        pull(has_answers)   
}


convert_label <- function(x) {
    x <- gsub("_([a-z])", " \\U\\1", x, perl = TRUE)
    x <- gsub("^([a-z])", "\\U\\1", x, perl = TRUE)
    gsub("sql", "SQL", x, ignore.case = TRUE)
}



ggassessment_hist <- function(data, mapping) {
    ggplot(data, mapping) +
        geom_col(fill = "darkcyan") +
        geom_text(aes(label = n), size = 4, nudge_y = 3) +
        scale_x_discrete(labels = function(x)
            lapply(strwrap(x, width = 10, simplify = FALSE),
                   paste, collapse = "\n")) +
        ylab("% Respondents") +
        theme_classic(base_size = 14)
}

ggassessment_lolli <- function(data, mapping, color) {
    data$percent <- data$percent / 100
    if (!identical(substr(color, 1, 1), "#")) {
        color <- match.arg(color, c("swc", "dc", "cp"))
        color <- switch(color,
                        swc = "#2f3f8e",
                        dc  = "darkcyan",
                        cp = "#071159")
    }
    
    ggplot(data, mapping) +
        geom_lollipop(col = color, horizontal = TRUE, point.size = 2.5) +
        geom_text(aes(label = n), size = 4, nudge_x = .0125, hjust = 0) +
        scale_x_continuous(expand=c(0, 0), labels=percent,
                           breaks=seq(0, 1, by = 0.2), limits = c(0, 1)) +
        scale_y_discrete(labels = function(x) str_wrap(x, width = 20)) +
        theme_minimal(base_size = 14) +
        theme(panel.grid.major.y = element_blank(),
              panel.grid.minor  = element_blank(),
              axis.line.y = element_line(color="#2b2b2b"),
              axis.text.y = element_text(margin = margin(r=0, l=0)),
              plot.margin = unit(c(5, 30, 10, 30), "pt"), 
              plot.title = element_text(margin = margin(r = 100, b = 10),
                                        face="bold"), 
              plot.subtitle = element_text(margin = margin(b = 10)), 
              plot.caption = element_text(size = 10, margin = margin(t = 10))) +
        labs(x = "% Respondents",
             y = "", 
             caption = "Numbers of answers reported on the graph")

}



make_likert_data <- function(.data, var_levels) {
    .data %>%
        select(-matches("_open_ended")) %>% 
        mutate_all(~ factor(., levels = var_levels, ordered = TRUE)) %>%
        as.data.frame() %>% 
        likert() %>%
        transform_likert_labels()     
}

add_member_org <- function(.data, membership_data =
                                    "../data/2018-08-member_organizations.csv"){

  member_data <- readr::read_csv(membership_data,
                                 col_types = cols(.default = "c"))
  .data %>%
    dplyr::left_join(
      dplyr::select(member_data, slug, member_org = fullname),
      by = "slug"
    ) 
}

filter_member_org <- function(.data, org) {
  if (! has_name(.data, "member_org"))
    stop("data set not formatted correctly. Column `member_org` not found.")
  
  .data %>%
    dplyr::filter(member_org == org)
}

```

```{r load-dc-data}
# Load DC pre and post-workshop data
# Data Carpentry Pre-Workshop Data
dcpredata <- readr::read_csv("../data/20180511_dcpre.csv",
                             col_types = cols(
                                 Date =  col_datetime(
                                     format = "%m/%d/%y %H:%M"
                                 ),
                                 .default = "c")
                             ) %>%
    rename(
        ## ---- discipline ----
        "discipline_1"  = Discipline,        
        "discipline_2"  = Column2, 
        "discipline_3"  = Column3, 
        "discipline_4"  = Column4, 
        "discipline_5"  = Column5, 
        "discipline_6"  = Column6, 
        "discipline_7"  = Column7, 
        "discipline_8"  = Column8, 
        "discipline_9"  = Column9, 
        "discipline_10" = Column10, 
        "discipline_11" = Column11, 
        "discipline_12" = Column12, 
        "discipline_13" = Column13,
        "discipline_other" = DisciplineOther, 
        ## ---- status ----
        "status_1" = Status, 
        "status_2" = Column15, 
        "status_3" = Column16, 
        "status_4" = Column17, 
        "status_5" = Column18, 
        "status_6" = Column19, 
        "status_7" = Column20,
        "status_8" = Column21,
        "status_9" = Column22,
        "status_other" = StatusOther,
        ## ---- why_attending ----
        "why_attending_1" = WhyAttending,
        "why_attending_2" = Column27,
        "why_attending_3" = Column28,
        "why_attending_4" = Column29,
        "why_attending_other" = WhyAttendingOther, 
        ## ---- exposure ----
        "exposure_1" = Exposure,
        "exposure_2" = Column31,
        "exposure_3" = Column32,
        "exposure_4" = Column33,
        "exposure_5" = Column34,
        "exposure_6" = Column35,
        "exposure_other" = ExposureOther,
        ## ---- ethnic_identiity ----
        "ethnic_identity_1" = RaceEthnicIdentity,
        "ethnic_identity_2" = Column44,
        "ethnic_identity_3" = Column45, 
        "ethnic_identity_4" = Column46,
        "ethnic_identity_5" = Column47,
        "ethnic_identity_6" = Column48,
        "ethnic_identity_7" = Column49, 
        "ethnic_identity_other" = RaceEthnicIdentityOther, 
        ## ---- Workshop ID  ----
        slug = WorkshopID
    ) %>%
  rename_all(to_snake_case) %>%
  filter(has_answers(.)) %>%
  add_member_org() %>%
  filter_member_org(params$org)

## Data Carpentry Post-Workshop Data
dcpostdata <- readr::read_csv("../data/20180511_dcpost.csv", 
                              col_types = cols(
                                Date =  col_datetime(
                                  format = "%m/%d/%y %H:%M"
                                ),
                                .default = "c"))  %>%
  rename(slug = WorkshopID) %>%
  rename_all(to_snake_case) %>%
  filter(has_answers(.)) %>%
  add_member_org() %>%
  filter_member_org(params$org)
```

```{r load-swc-data}
## Load SWC pre and post-workshop data
## Software Carpentry Pre-Workshop Data
swcpredata <- readr::read_csv("../data/20180521_swcpre.csv",
                              col_types = cols(
                                  Date =  col_datetime(
                                      format = "%m/%d/%y %H:%M"
                                  ),
                                  .default = "c")
                              ) %>%
    rename(
        ## ---- why_attending ----
        "why_attending_1" = WhyAttending,
        "why_attending_2" = Column4,
        "why_attending_3" = Column5,
        "why_attending_4" = Column6,
        "why_attending_5" = Column7, 
        "why_attending_other" = WhyAttendingOther, 
        ## ---- factors ----
        "factors_1" = Factors,
        "factors_2" = Column13,
        "factors_3" = Column14,
        "factors_other" = FactorsOther,
        ## ---- exposure ----
        "exposure_1" = Exposure,
        "exposure_2" = Column16,
        "exposure_3" = Column17,
        "exposure_4" = Column18,
        "exposure_5" = Column19,
        "exposure_6" = Column20,
        "exposure_7" = Column21,
        "exposure_other" = ExposureOther,
        ## ---- domain ----
        "domain_1" = Domain,
        "domain_2" = Column47,
        "domain_3" = Column48,
        "domain_4" = Column49,
        "domain_5" = Column50,
        "domain_6" = Column51,
        "domain_7" = Column52,
        "domain_8" = Column53,
        "domain_9" = Column54,
        "domain_10" = Column55,
        "domain_11" = Column56,
        "domain_12" = Column57,
        "domain_13" = Column58,
        "domain_14" = Column59,
        "domain_15" = Column60,
        "domain_16" = Column61,
        "domain_other" = DomainOther, 
        ## ---- Workshop ID  ----
        slug = WorkshopID
    ) %>%
    rename_all(to_snake_case) %>%
    filter(is.na(over18) | over18 == "Yes") %>%
  filter(has_answers(.))  %>%
  add_member_org() %>%
  filter_member_org(params$org)

## Software Carpentry Post-Workshop Data
swcpostdata <- readr::read_csv("../data/20180521_swcpost.csv",
                               col_types = cols(
                                 Date =  col_datetime(
                                   format = "%m/%d/%y %H:%M"
                                 ),
                                 .default = "c")
                               ) %>%
    rename(
        ## ---- domain ----
        "domain_1" = Domain,
        "domain_2" = Column50,
        "domain_3" = Column51,
        "domain_4" = Column52,
        "domain_5" = Column53,
        "domain_6" = Column54,
        "domain_7" = Column55,
        "domain_8" = Column56,
        "domain_9" = Column57,
        "domain_10" = Column58,
        "domain_11" = Column59,
        "domain_12" = Column60,
        "domain_13" = Column61,
        "domain_14" = Column62,
        "domain_15" = Column63,
        "domain_16" = Column64,
        "domain_other" = DomainOther, 
        ## ---- Workshop ID  ----
        slug = WorkshopID
    ) %>%
    rename_all(to_snake_case) %>%
    filter(is.na(above18) | above18 == "Yes") %>%
  filter(has_answers(.)) %>%
  add_member_org() %>%
  filter_member_org(params$org)
```

```{r overview-inline-stats}
## variables to switch different parts of the report
has_dc_predata <- nrow(dcpredata) > 0
has_dc_postdata <- nrow(dcpostdata) > 0
has_swc_predata <- nrow(swcpredata) > 0
has_swc_postdata <- nrow(swcpostdata) > 0

## number of learners
n_learners_pre_dc <- nrow(dcpredata)
n_learners_post_dc <- nrow(dcpostdata)
n_learners_pre_swc <- nrow(swcpredata)
n_learners_post_swc <- nrow(swcpostdata)

## time period covered
dc_dates <- range(c(dcpredata$date, dcpostdata$date))
swc_dates <- range(c(swcpredata$date, swcpostdata$date))
```

```{r summary-responses}
tibble::tribble(
  ~"Workshop Type", ~"Pre/Post", ~"Number of responses",
  "Software Carpentry", "Pre", n_learners_pre_swc,
  "Software Carpentry", "Post", n_learners_post_swc,
  "Data Carpentry", "Pre", n_learners_pre_dc,
  "Data Carpentry", "Post", n_learners_post_dc
) %>%
  knitr::kable()

```

## Overview

Since `r format(min(c(dc_dates, swc_dates)), format="%B %d, %Y")`, Software and Data Carpentry have collected information on learner demographics, perception of tools, and confidence in working with data. As a benefit of partnering with the Carpentries, the Assessment Team will release bi-annual snapshots of the results of pre- and post-workshop surveys and instructor training, customized for each member organization. 

This report covers the workshops from `r format(min(swc_dates), format="%B %d, %Y")` to `r format(max(swc_dates), format="%B %d, %Y")` for Software Carpentry, and from  `r format(min(dc_dates), format="%B %d, %Y")` to `r format(max(dc_dates), format="%B %d, %Y")` for Data Carpentry.

As an overview, `r n_learners_pre_dc` and `r n_learners_post_dc` learners have responded to Data Carpentry pre- and post-workshop surveys respectively at your institution, while `r n_learners_pre_swc` and `r n_learners_post_swc` have responded to Software Carpentry workshop surveys. 

This report includes the following:

- Member Site History
- Number of Workshops (SWC, DC)
- List and Dates of Workshops and Number of Participants
- Participant Data from Learner Reports
- Net Promoter Score
- Applicability of the Skills Learned
- Instructor Training Information (where available)
- Summary

## Member Site History
[SITE NAME] has been a member site with The Carpentries since XX at the XX membership level. Check out our [website](https://carpentries.org/membership/) for information on membership tiers.

## Number of Workshops
Since XX, there have been XX Data Carpentry and XX Software Carpentry workshops at your institution.

```{r dc-workshop-type, eval=has_dc_postdata}
# Workshop topics
# Data Carpentry: Which workshop are you attending?
workshop_types <- c("Ecology", "Genomics", "Reproducible Research",
                    "Social Sciences", "Geospatial", "I don't know.",
                    "Didn't answer")

dc_workshop_type <- dcpostdata %>%    
    summarize_single_column(workshop, workshop_types)

## dc_workshop_type %>%
##     kable(format = 'markdown', row.names = NA,
##           col.names = c ("Data Carpentry Workshop Type Attended", "n", "%"))
```


```{r dc-workshop-type-plot, eval=has_dc_postdata}
ggassessment_lolli(dc_workshop_type,
                   aes(y = factor(workshop, levels = rev(workshop_types)),
                       x = percent), color = "dc") +                       
    labs(
        title = "Majority of Data Carpentry Respondents \nAttend Ecology Workshops"
    )

```	


## List and Dates of Workshops and Number of Participants
Below we have outlined a list of the dates of your workshops since XX, and number of participants. We rely on the instructors to tell us how many participants attended workshops. If your records do not match this list, please [contact Elizabeth Williams](mailto:ewilliams@carpentries.org).

## Participant Data from Learner Reports

Understanding why learners attend Carpentries workshops may help you in your strategy to organize and host workshops. Thus, we've provided a synopsis of participant data from learner reports as follows:

- Learner Demographics
- Why learners participate in workshops at your institution
- Paired Data (for workshops with more than 30 respondents)
- Perception of Instructors 
- Quantitative Responses

### Learner Demographics
#### Discipline

The distribution of your learners by discipline is provided below for both Data and Software Carpentry workshops held at your institution.
```{r dc-discipline, eval=has_dc_predata}
## Domain 
## Tally Data Carpentry's pre-workshop respondents by Discipline
## Responses are in columns 'Discipline' through 'Column13'
dc_discipline_data <- dcpredata %>%
    extract_multi_columns("discipline")

dc_discipline <- dc_discipline_data %>%
    summarize_multi_columns()

get_dc_discipline_percent <- function(discipline_var, .data = dc_discipline) {
    extract_percentage(.data, .var = column_name, .value = discipline_var) 
}

dc_discipline %>%
    render_table(
        question, 
        col.names = c("Data Carpentry's Respondents by Discipline", "n", "%")
    )
```

```{r swc-discipline, eval=has_swc_predata}
# Tally Software Carpentry's pre-workshop respondents by Discipline
# Responses are in columns 'Domain' through 'Column61'
swc_discipline_data <- swcpredata %>%
    extract_multi_columns("domain")

swc_discipline <- swc_discipline_data %>%
    summarize_multi_columns()
    
swc_discipline %>%
    render_table(
        question, 
        col.names = c("Software Carpentry's Respondents by Discipline", "n", "%"))
```

#### Career Stage

The figures below provide a breakdown of your learners by career stage for both Data and Software Carpentry workshops.

```{r dc-staus, eval=has_dc_predata}
# Position/Status
# Data Carpentry Respondents by Status
# Responses are in columns 'Status' through 'Column22'
dc_status_levels <- c("Undergraduate Student", "Graduate Student",
                      "Postdoctoral Researcher", "Faculty", "Industry Employee",
                      "Government Employee", "Research Staff",
                      "Management/Administrator", "Retired/Not Employed",
                      "Other")

dc_status_data <- dcpredata %>%
    extract_multi_columns("status")

dc_status <- dc_status_data %>%
    summarize_multi_columns()

get_dc_status_percent <- function(status_var, .data = dc_status) {
    extract_percentage(.data, .var = column_name, .value = status_var)
}

dc_status %>%
    render_table(
        question, 
        col.names = c("Data Carpentry's Respondents by Career Stage", "n", "%")
    )
```


```{r swc-status, eval=has_swc_predata}
## Software Carpentry Respondents by Position/Status
swc_status_levels <- c(    
    "Undergraduate Student",
    "Graduate Student",
    "Post-doctoral researcher",
    "Faculty",
    "Research staff (including research programmer)",
    "Support staff (including technical support)",
    "Librarian/archivist",
    "Commercial software developer",
    "Other (please specify)",
    "Didn't answer"
    )

swc_status <- swcpredata %>%
    summarize_single_column(status, swc_status_levels)

get_swc_status_percent <- function(status_var, .data = swc_status) {
    extract_percentage(.data, .var = status, .value = status_var)
}
```

```{r dc-status-plot, eval=has_dc_predata, fig.height=7}
## Data Carpentry plot of learners by position/status
ggassessment_lolli(dc_status,
                   aes(y = factor(question, levels = rev(dc_status_levels)),
                       x = percent), color = "dc") +
    labs(
        title = "Data Carpentry Respondents by Career Stage"
    )
```

```{r swc-status-plot, eval=has_swc_predata, fig.height=8}
# Plot for Software Carpentry Respondents by Position/Status
ggassessment_lolli(swc_status,
                   aes(
                       y = factor(status, rev(swc_status_levels)),
                       x = percent
                   ), color = "swc") +
    labs(
        title = "Software Carpentry Respondents by Career Stage"
    )
```

#### Gender and Racial/Ethnic Identity

Gender and racial/ethnic identity information is collected for U.S. participants, as we are keen to increase the number of diverse instructors and learners we serve. This information is provided below for the learners attending your workshops.

```{r dc-gender, eval=has_dc_predata}
# Gender Identity 
# Data Carpentry
# With what gender do you most identify?
dc_gender_levels <- c("Female", "Male", "Transgender female",
                      "Transgender male", "Gender variant/non-conforming",
                      "Prefer not to answer", "Didn't answer")

dcpredata$gender_identity <- iconv(dcpredata$gender_identity, "latin1", "ASCII",
                                   sub=" ")

dc_gender <- dcpredata %>%
    filter(country == "United States of America") %>% 
    summarize_single_column(gender_identity, dc_gender_levels) 

dc_gender_female <- dc_gender %>%
    filter(gender_identity == "Female") %>%
    pull(percent)

dc_gender %>%
    render_table(
        gender_identity, 
        col.names = c("Data Carpentry's U.S. Respondents' Gender Identity",
                      "n", "%"),
        arrange = FALSE)
```

```{r dc-ethnicity, eval=has_dc_predata}
# Data Carpentry: Race/Ethnic Identity
# Responses are in columns 'RaceEthnicIdentity' through 'Column49'
dc_ethnicity_data <- dcpredata %>%
    filter(country == "United States of America") %>%
    extract_multi_columns("ethnic_identity")

dc_ethnicity <- dc_ethnicity_data %>%
    summarize_multi_columns()

dc_underrepresented <- dc_ethnicity %>%
    filter(question != "White") %>%
    pull(percent) %>%
    sum()

dc_ethnicity %>%
    render_table(
        question, 
        col.names = c("Data Carpentry's U.S. Respondents Racial/Ethnic Identity",                      
                      "n", "%"),
        arrange = FALSE)
```

```{r swc-gender, eval=has_swc_predata}
# Software Carpentry
# With what gender do you most identify?
swc_gender_levels <- c("Female", "Male", "Other", "Prefer not to say")

swc_gender <- swcpredata %>%
    filter(us_workshop == "Yes") %>% 
    summarize_single_column(gender, swc_gender_levels)

swc_gender_female <- swc_gender %>%
    filter(gender == "Female") %>%
    pull(percent)

swc_gender %>%
    render_table(
        gender, 
        col.names = c("Software Carpentry's U.S. Respondents' Gender Identity",
                      "n", "%"),
        arrange = FALSE)

```

```{r swc-ethnicity, eval=has_swc_predata}
# Software Carpentry: Race/Ethnic Identity
swc_ethnicity_levels <- c("American Indian or Alaskan Native",
                          "Asian / Pacific Islander",
                          "Black or African American", "Hispanic or Latino",
                          "Native Hawaiian or Other Pacific Islander",
                          "White / Caucasian",
                          "Multiple ethnicity / Other (please specify)",
                          "Prefer not to say")

swc_ethnicity <- swcpredata %>%
    filter(us_workshop == "Yes") %>% 
    summarize_single_column(race, swc_ethnicity_levels)

swc_underrepresented <- swc_ethnicity %>%
    filter(race != "White / Caucasian") %>%
    pull(percent) %>%
    sum()

swc_ethnicity %>%
    render_table(
        race, 
        col.names = c("Software Carpentry's U.S. Respondents' Racial/Ethnic Identity",
                      "n", "%"),
        arrange = FALSE)

```

### Why are learners participating in your workshops?

Respondents were asked to check all that apply for several factors provided in the tables below.

```{r why-attending-helpers}
tally_nona <- function(x) sum(!is.na(x))
percent_nona <- function(x) round(tally_nona(x)/length(x) * 100, 1)

## Extract the relevant columns, and remove answers where repondant didn't
## select anything.
extract_multi_columns <- function(.data, column_prefix) {
  .data %>%
    select(starts_with(column_prefix),
           ) %>%
    filter(has_answers(.))
}

summarize_multi_columns <- function(.data) {

  ## Make table of column name to question correspondance
  get_key_multi_answer <- . %>%
    gather(column_name, question) %>%
    filter(!is.na(question)) %>%
    mutate(question = case_when(
      grepl("_(other|open_ended)", column_name) ~ "Other",
      TRUE ~ question)
      ) %>%
    distinct(column_name, question)

  ## Get numbers and percentage of each option
  tally_percent_multi_answer <- . %>%
    summarize_all(funs(n = tally_nona, percent = percent_nona)) %>%    
    gather() %>%
    extract(key, c("column_name", "metric"),
            regex = "([a-z_]+_[a-z0-9]+)_(n|percent)") %>%
    spread(metric, value)

  answer_key <- .data %>%
    get_key_multi_answer

  .data %>%
    tally_percent_multi_answer %>%
    inner_join(answer_key, by = "column_name")
}

extract_percentage <- function(.data, .var, .value) {
  col_var <- enquo(.var)
  .data %>%
    filter(!!col_var == .value) %>%
    pull(percent)
}

render_table <- function(.data, col, col.names, arrange = TRUE) {
  col <- enquo(col)

  res <- .data  %>%
    select(!! col, n, percent)

  if (arrange)
    res <- res %>%
      arrange(desc(n))

  res %>% 
    kable(format = 'markdown', row.names = NA,
          col.names =  col.names)
}

summarize_single_column <- function(.data, .var, var_levels) {
  var <- enquo(.var)
  
  .data %>%
    select(!! var) %>%
    mutate(!! quo_name(var) := replace(!!var, is.na(!!var),
                                       "Didn't answer")) %>%
    count(!!var) %>%
    right_join(expand(., !! quo_name(var) := na.omit(var_levels)),
               by = quo_name(var)) %>%
    replace_na(list(n = 0)) %>% 
    mutate(percent = round(n/sum(n) * 100, 1)) %>%
    arrange(factor(!!var, levels = var_levels)) 
}

transform_likert_labels <- function(.data) {
  .data$results$Item <- convert_label(.data$results$Item)
  names(.data$items) <- convert_label(names(.data$items))
  .data
}


```

```{r dc-why-attending, eval=has_dc_predata}
## Why are you attending this workshop?
dc_why_attending_data <- dcpredata %>%
    extract_multi_columns("why_attending")
  
  dc_why_attending <- dc_why_attending_data %>%
    summarize_multi_columns()
  
  ### inline statistics
  n_dc_why_attending <- nrow(dc_why_attending_data)

  ## percent of DC learners coming to learn skills they will use in the future (in
  ## column 'why_attending_1').
  p_work_future <- dc_why_attending %>%
    extract_percentage(column_name, "why_attending_1") 

  ## table
  dc_why_attending %>%
    render_table(
      question,
      col.names = c(
        paste0(
          "Why learners attend Data Carpentry workshops? (n = ",
          n_dc_why_attending, ")"),
        "n", "%")
    )
```

XXX% of Data Carpentry learners attended workshops at your institution to learn skills they can apply to their current work.

Software Carpentry’s curriculum teaches basic lab skills for scientific computing. These workshops include automation with the Unix shell, version control with Git, and programming with R or Python. These tools help learners to increase the efficiency and reproducibility of their computational work.

```{r swc-why-attending, eval=has_swc_predata}
# Why are you attending this workshop?
swc_why_attending_data <- swcpredata %>%
    extract_multi_columns("why_attending")
    
swc_why_attending <- swc_why_attending_data %>%
    summarize_multi_columns()

### inline statistics
n_swc_why_attending <- nrow(swc_why_attending_data)

## percent SWC learners coming to learn new/additional topics (in column
## 'why_attending_2').
p_swc_why_attending <- swc_why_attending %>%
    extract_percentage(column_name, "why_attending_2")

## table
swc_why_attending %>%
    render_table(
        question, 
        col.names = c(
              paste0("Why learners attend Software Carpentry Workshops? (n = ",
                     n_swc_why_attending, ")"),
            "n", "%")
    )
```	


```{r first-timers-swc, eval=has_swc_predata}
# 1st time attending 
# Software Carpentry: Will this be your first time attending a SWC workshop (as a learner)?

swc_first_timers <- swcpredata %>%
    summarize_single_column(first_time, c("Yes", "No", "Didn't answer"))

p_first_timers <- swc_first_timers %>%
    extract_percentage(first_time, "Yes")

swc_first_timers %>%
    render_table(
        first_time, 
        col.names = c ("Software Carpentry 1st Time Learners", "n", "%")
    )
```

Compared to Data Carpentry's learners, Software Carpentry's tend to have more experience with the tools covered in the workshops, and learners come to learn new and/or additional topics (X%). 

### Paired Data (for workshops with more than 30 respondents)
## Effect of Workshops on Learners Self-Reported Perspectives: Skills & Confidence

Your learners were asked to rate their level of agreement with several statements related to Data Carpentry's workshop goals and learning objectives. The figure below provides a visual representation of their responses, comparing them before the workshop and after the workshop. Axis labels and the corresponding question are organized around three themes as follows:

* Efficiency:
    + __Write Program__: I can write a small program/script/macro to solve a
      problem in my own work.
    + __Programming Efficient__: Using a programming language (like R or
      Python) can make me more efficient at working with data.
* Reproducibility:
	  + __Raw Data__: Having access to the original, raw data is important to be
	  able to repeat an analysis.
	  + __Analyses Easier__: Using a programming language (like R or Python) can
      make my analyses easier to reproduce.
* Self-Efficacy
	  + __Search Online__: I know how to search for answers to my technical
      questions online.
	  + __Overcome Problem__: While working on a programming project, if I get
      stuck, I can find ways of overcoming the problem.
	  + __Programming Confident__: I am confident in my ability to make use of
      programming software to work with data.

The scoring for the above factors ranges from strongly disagree (1) to strongly agree (5).

```{r dc-paired-data, eval=has_dc_predata & has_dc_postdata}
## Data Carpentry
## Ability to perform various computing tasks before and after completing the workshop
## Paired analysis plot to compare DC pre scores with post scores
prep_paired_data <- . %>%
    select(unique_id, raw_data:programming_efficient) %>%
    filter(!is.na(unique_id)) %>%
    gather(skill, feeling, -unique_id) %>%
    mutate(feeling_score = case_when(
               feeling == "Strongly disagree" ~ 1,
               feeling == "Disagree"          ~ 2,
               feeling == "Neutral"           ~ 3,
               feeling == "Agree"             ~ 4, 
               feeling == "Strongly agree"    ~ 5,
               is.na(feeling)                 ~ NA_real_, 
               TRUE                           ~ 999
           )) %>%
    assert(in_set(NA, 1, 2, 3, 4, 5), feeling_score)


pre_paired <- dcpredata %>%
    prep_paired_data %>%
    rename_at(vars(-unique_id, -skill), ~ paste0("pre_", .))
    
post_paired <- dcpostdata %>%
    prep_paired_data %>%
    rename_at(vars(-unique_id, -skill), ~ paste0("post_", .))

paired_data <- inner_join(pre_paired, post_paired, by = c("unique_id", "skill")) %>%
  filter(!is.na(pre_feeling_score) & !is.na(post_feeling_score))

has_dc_paired <- nrow(paired_data) > 0
```

```{r dc-paired-data-mean, eval=has_dc_predata & has_dc_postdata}
paired_data %>%
    select(unique_id, skill,
           pre_feeling_score,
           post_feeling_score) %>%
    gather(score, type, -unique_id, -skill) %>%
    mutate(skill = convert_label(skill)) %>%
    group_by(skill, score) %>%
    summarize(
        mean = mean(type, na.rm = TRUE),
        sd = sd(type, na.rm = TRUE)
    ) %>%
    ungroup() %>% 
    mutate(skill = factor(skill,
                          levels = rev(c(
                              "Write Program",
                              "Programming Efficient",
                              "Raw Data",
                              "Analyses Easier",
                              "Search Online",
                              "Overcome Problem",
                              "Programming Confident"
                          )))) %>% 
    ggplot(aes(x = skill, y = mean, color = score)) +
    geom_point(size=5) +
    coord_flip() +
    ylim(c(0, 5)) +
    theme_minimal() +
    scale_color_viridis(breaks = c("pre_feeling_score", "post_feeling_score"),
                        labels = c("Pre-workshop Score",
                                   "Post-workshop Score"), 
                        end = .7, discrete=TRUE) +
    labs(title = "Pre and Post Comparison of Skills and Perception") +
    theme(text = element_text(size = 16))

```

The comparison above is paired, meaning, we are comparing those who provided us with a unique identifier and who completed both the pre- and post-workshop survey. This figure includes X responses.

In the figures below, we show another representation of the pre- and post-comparison of respondents skills and perspectives. The figures below include the data for all learners, not only those who provided a unique identifier *and* took both the pre- and post-workshop surveys.

The neutral centered graphs below provide an even clearer picture of the shift in respondents' self-reported confidence and skills. 

```{r dc-tools-perception, eval=has_dc_predata & has_dc_postdata, fig.height=12}
# Data Carpentry pre-workshop neutral centered graph code
perception_levels <- c("Strongly disagree", "Disagree", "Neutral", "Agree",
                       "Strongly agree")

prep_perception_tools <- . %>%
    select(raw_data:programming_efficient) %>%
    filter(has_answers(.)) %>% 
    make_likert_data(perception_levels)

dc_pre_perception_tools <- dcpredata %>%
    prep_perception_tools

dc_post_perception_tools <- dcpostdata %>%
    prep_perception_tools

dc_pre_tools_likert <- dc_pre_perception_tools %>%
    plot() +
    labs(
        title = "Data Carpentry Respondents: Pre-Workshop Perception of Tools"
    ) +
    theme(legend.position = "none")

dc_post_tools_likert <- dc_post_perception_tools %>%
    plot() +
    labs(
        title = "Data Carpentry Respondents: Post-Workshop Perception of Tools"
    )

## summary likert
summarize_programming_confidence <- .  %>%
    filter(Item == "Programming Confident") %>%
    select("Agree", "Strongly agree") %>%
    sum() %>%
    round(0)

dc_pre_confidence_programming <- dc_pre_perception_tools$results %>%
    summarize_programming_confidence


dc_post_confidence_programming <- dc_post_perception_tools$results %>%
    summarize_programming_confidence


## combine both plots
dc_pre_tools_likert + dc_post_tools_likert +
    plot_layout(ncol=1)
```

Software Carpentry Respondents were asked to tell us about their experience with these topics before the workshop:

+ R
+ Unix Shell
+ SQL
+ Python
+ Version Control with Git

```{r swc-pre-tools, eval=has_swc_postdata}
## Software Carpentry
## Software Carpentry
## Pre/Post plots for knowledge and perception of tools covered
## Because the pre- and post- columns are quite different, we
## cannot put them on the same plot. So let's do two plots then stack them up

pre_knowledge_levels <- c("Little or no knowledge of topic",
                          "Some knowledge of topic",
                          "Extensive knowledge of topic")

post_knowledge_levels <- c("No increase in my knowledge",
                           "Knowledge increased slightly",
                           "Knowledge increased a little",
                           "Knowledge increased a great deal")

swc_pre_knowledge <- swcpostdata %>% 
    select(matches("knowledge_pre")) %>%
    rename_all(~ gsub("_pre", "", .)) %>%
    filter(has_answers(.))

swc_post_knowledge <- swcpostdata %>%
    select(matches("knowledge_increase")) %>%    
    rename_all(~ gsub("_increase", "", .)) %>%
    filter(has_answers(.))

swc_pre_knowledge_likert_data <- swc_pre_knowledge %>%
    make_likert_data(pre_knowledge_levels)

swc_pre_knowledge_range <- range(swc_pre_knowledge_likert_data$results$`Extensive knowledge of topic`)

swc_pre_knowledge_topic_min <- swc_pre_knowledge_likert_data$results[swc_pre_knowledge_likert_data$results$`Extensive knowledge of topic` == min(swc_pre_knowledge_range), "Item"]

swc_pre_knowledge_topic_max <- swc_pre_knowledge_likert_data$results[swc_pre_knowledge_likert_data$results$`Extensive knowledge of topic` == max(swc_pre_knowledge_range), "Item"]


swc_pre_knowledge_likert_data %>% 
    plot() +
    labs(
        title = "Software Carpentry Self-Reported Knowledge of Tools Covered Pre-Workshop"
    )
```

When asked their knowledge of the tools covered in their workshops, they rated their knowledge as extensive from X% to X% for "X" and "X".

The following is a comparison of your Software Carpentry respondents' knowledge about the tools before compared to after the workshop.

```{r swc-knowledge-change, eval=has_swc_predata & has_swc_postdata, fig.height=10}

prep_knowledge_plot <- function(.data, var_levels) {
    .data %>%
        gather(skill, level) %>%
        filter(level %in% var_levels) %>%
        count(skill, level) %>%
        group_by(skill) %>%
        mutate(n_skill = sum(n),
               percent = round(n/n_skill * 100, 1)) %>%
        ungroup() %>% 
        mutate(skill = convert_label(skill))    
}

ggknowledge <- function(data, mapping) {
    data <- mutate(data, text_pos = percent + .75)
    ggplot(data, mapping) +
        geom_col(position = "dodge") +
        geom_text(aes(label = n, y = text_pos), size= 3, hjust = 0, 
                  position = position_dodge(width = .9)) +
        theme_classic() +
        coord_flip() + 
        scale_fill_viridis(name = "", discrete = TRUE) +
        labs(
            x = "",
            y = "% Respondants"
        )
}

swc_pre_knowledge_plot <- swc_pre_knowledge %>%
    prep_knowledge_plot(pre_knowledge_levels) %>%
    ggknowledge(aes(x = skill, y = percent,
                    fill = factor(level, levels = rev(pre_knowledge_levels)))) +
    labs(
        title =  "Knowledge Before SWC Workshop"
    ) +
    theme(legend.position="bottom")

swc_post_knowledge_plot <- swc_post_knowledge %>% 
    prep_knowledge_plot(post_knowledge_levels) %>%
    ggknowledge(aes(x = skill, y = percent,
                    fill = factor(level, levels = rev(post_knowledge_levels)))) +
    labs(
        title = "Knowledge After SWC Workshop"
    ) +
    theme(legend.position="bottom")


swc_pre_knowledge_plot + swc_post_knowledge_plot +
    plot_layout(ncol = 1)

```

### Perception of Instructors 
Your Data Carpentry workshop respondents were asked to rate their level of agreement with several statements regarding their instructors' knowledge, instructional method, and enthusiasm. Their responses are in the figure below, and axis labels correspond to the statements as follows:

+ __Instructors Knowledge__: The instructors were knowledgeable about the material being taught.
+ __Instructors Interacting__: I felt comfortable interacting with the instructors. 
+ __Instructors Enthusiastic__: The instructors were enthusiastic about the workshop.
+ __Instructors Clear Answers__: I was able to get clear answers to my questions from the instructors. 

```{r dc-perception-instructors-data, eval=has_dc_postdata}
## Perception of instructors and helpers
## Data Carpentry
perception_levels <- c("Strongly disagree", "Disagree", "Neutral", "Agree",
                       "Strongly agree")

dc_perception_instructors_data <- dcpostdata %>%
    extract_multi_columns("instructors")

dc_perception_percent_agree <- dc_perception_instructors_data %>%
    summarize_all(~ sum(. %in% c("Agree", "Strongly agree"))/length(.)) %>%
    gather(skill, percent) %>%
    mutate(percent = round(percent * 100, 1))

dc_perception_instructors_interacting <- dc_perception_percent_agree %>%
    filter(skill == "instructors_interacting") %>%
    pull(percent)

dc_perception_instructors_clear_answers <- dc_perception_percent_agree %>%
    filter(skill == "instructors_clear_answers") %>%
    pull(percent)

dc_perception_instructors_knowledgeable <- dc_perception_percent_agree %>%
    filter(skill == "instructors_knowledgeable") %>%
    pull(percent)

dc_perception_instructors_enthusiastic <- dc_perception_percent_agree %>%
    filter(skill == "instructors_enthusiastic") %>%
    pull(percent)

dc_perception_instructors_likert <- dc_perception_instructors_data %>%
    make_likert_data(perception_levels)
```

```{r dc-perception-instructors-heatmap, eval=has_dc_postdata}
## Data Carpentry
## Heatmap for Data Carpentry perception of instructors and helpers
title <- "Perception of Data Carpentry Instructors"

plot(dc_perception_instructors_likert,
     type = "heat",
     panel.arrange = NULL, panel.strip.color = "darkcyan",
     legend.position = "bottom") +
    ggtitle(title)
```

X% of respondents said they felt comfortable interacting with the instructors. X% and X% of respondents felt your instructors were knowledgeable about the material being taught, and were enthusiastic about the workshop, respectively. Lastly, X% of respondents felt they were able to get clear answers to their questions from their instructors.

Software Carpentry respondents were asked to rate how they felt instructors and helpers worked as a team, based on the following criteria:

+ __Considerate__: Instructors/Helpers were considerate.
+ __Enthusiastic__: Instructors/Helpers were enthusiastic. 
+ __Clear Answers__: Instructors/Helpers gave clear answers to your questions. 
+ __Communicators__: Instructors/Helpers were good communicators.    

The two neutral centered plots below provide an analysis of respondent's answers for both instructors and helpers.

```{r swc-perception-instructors, eval=has_swc_postdata}
## Software Carpentry: Perception of SWC workshop instructors/helpers
frequency_levels <- c("Never", "Rarely", "Sometimes", "Often",
                      "All of the time")

swc_instructor_perception_data <- swcpostdata %>%
    extract_multi_columns("instructors")

swc_instructor_perception_likert <- swc_instructor_perception_data %>%
    make_likert_data(frequency_levels)

## Software Carpentry Instructors Plot
plot(swc_instructor_perception_likert) +
    ggtitle("Perception of Software Carpentry Instructors")
```

```{r swc-perception-helpers, eval=has_swc_postdata}
swc_helper_perception_likert <- swcpostdata %>%
    extract_multi_columns("helpers") %>%
    ## wrong column name in data
    rename(helpers_considerate = helpers_teamwork) %>% 
    make_likert_data(frequency_levels)

## Software Carpentry: Helpers Plot
plot(swc_helper_perception_likert) +
    ggtitle("Perception of Software Carpentry Helpers")
```

### Quantitative Responses



## Net Promoter Score
We use the [Net Promoter Score](https://en.wikipedia.org/wiki/Net_Promoter) to measure learners' likelihood of recommending workshops to a friend or colleague. The scoring for this question is on a 0 to 100 scale. Respondents scoring from 0 to 64 are labeled *Detractors*, and are believed to be less likely to recommend a workshop. Those who respond with a score of 85 to 100 are called *Promoters*, and are considered likely to recommend a workshop. Respondents between 65 and 84 are labeled *Passives*, and their behavior falls between Promoters and Detractors.

```{r nps-code}
compute_nps <- . %>%
    pull(likely_to_recommend) %>%
    as.numeric() %>% 
    npc(breaks = list(0:64, 65:84, 85:100)) %>%
    data_frame(category = .) %>%
    mutate(category = as.character(category),
           category = replace_na(category, "Didn't answer")) %>% 
    count(category) %>%
    mutate(percent = round(n / sum(n) * 100, 1)) %>%
    arrange(category = factor(category,
                              levels = c("Detractor",  "Passive",
                                         "Promoter",
                                         "Didn't answer")))
compute_nps_percent <- . %>%
    filter(category != "Didn't answer") %>%
    mutate(p = round(n / sum(n) * 100, 1)) %>%
    filter(category == "Promoter") %>% 
    pull(p) 
```

```{r dc-nps, eval=has_dc_postdata}
## NPS 
## Data Carpentry
dc_nps  <- dcpostdata %>%
    compute_nps

dc_nps %>%
    render_table(
        category, 
        col.names = c("Data Carpentry Net Promoter Score", "n", "%"),
        arrange = FALSE
    )

dc_nps_promoters <- dc_nps %>%
    compute_nps_percent
```

X% of your Data Carpentry respondents who answered this question are promoters (i.e. would recommend a workshop). 

```{r swc-nps, eval=has_swc_postdata}
# NPS
# Software Carpentry
swc_nps <- swcpostdata %>%
    mutate(likely_to_recommend = as.numeric(likely_to_recommend) * 10) %>%
    compute_nps

swc_nps_percent <- swc_nps %>%
    compute_nps_percent
```

For Software Carpentry respondents who answered this questions, X% are promoters.

We hope you share in our committment to making participation in workshops a
harassment-free experience for everyone, regardless of who learners are, where they are from, or what their experience is with the tools we teach. We teach instructors to establish norms for interaction by having, discussing, and enforcing a Code of Conduct so that your workshops provide open and inclusive learning environments. X% of Data Carpentry respondents from your workshops either agree or strongly agree that they felt comfortable learning in their workshop environment, and X% of Software Carpentry's respondents agreed or strongly agreed that the workshop atmosphere was welcoming.

## Applicability of the Skills Learned

```{r dc-skill-applicability, eval=has_dc_postdata}
## Data Carpentry: I can immediately apply what I learned at this workshop
applicability_levels <- c("Strongly disagree", "Disagree", "Neutral", "Agree",
                          "Strongly agree", "Didn't answer")

dc_applicability <- dcpostdata %>%
    summarize_single_column(immediately_apply, applicability_levels)

dc_applicability_percent <- dc_applicability %>%
    filter(immediately_apply %in% c("Agree", "Strongly agree")) %>%
    summarize(p = sum(percent)) %>%
    pull(p)
```

One of the goals for Data Carpentry's lessons is that learners are able to
immediately apply what they learned at the workshop. The figure below shows that
X% either agree or strongly agree that they were able to apply what they learned immediately after attending a workshop at your institution.

```{r dc-skill-applicability-plot, eval=has_dc_postdata}
ggassessment_lolli(dc_applicability,
                   aes(y = factor(immediately_apply,
                                  levels = rev(applicability_levels)),
                       x = percent), color = "dc") +
    labs(
        title = "Data Carpentry respondents can immediately apply \nwhat they learned at the workshop" 
    )
```

## Instructor Training Information 

## Summary
In summary, we hope that you will use the figures above as a resource to make the case to continue organizing Software and Data Carpentry workshops at your institution.

This report focused on Data and Software Carpentry learners' skills, perspectives, and experiences in your workshops. Our two-day coding workshops increase researchers’ daily programming usage, and confidence in working with open source tools. If you'd like to discuss the results from this report, please [contact](mailto:kariljordan@carpentries.org) Kari L. Jordan, Director of Assessment and Community Equity for The Carpentries.
